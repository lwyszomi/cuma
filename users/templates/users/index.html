{% extends "users/base_template.html" %}
{% load static %}
{% load i18n %}
{% block js %}
    {{ block.super }}
    <script>
        angular.module('cumaApp').constant('usersConfig', {
            "users": {{ users|safe }},
            "countries": {{ countries|safe }}
        })
    </script>
    <script src="{% static 'users/js/controllers/filters.js' %}"></script>
    <script src="{% static 'users/js/controllers/table_controller.js' %}"></script>
{% endblock %}

{% block container %}
    <div class="top10" ng-app="cumaApp" ng-controller="tableController as table">
        <div class="form-horizontal" id="filters">
            <div class="form-group">
                <label class="col-sm-2 control-label" for="search">Search:</label>
                <div class="col-sm-8">
                    <div class="input-group">
                      <input id="search" class="form-control" type="text" name="search" ng-model="table.searchField" ng-model-options="{ updateOn: 'default blur', debounce: { 'default': 200, 'blur': 1 } }" placeholder="Name, Email, Username"/>
                      <span class="input-group-btn">
                        <button class="btn btn-secondary" type="button" ng-click="table.searchField = ''"><i class="glyphicon glyphicon-remove"></i></button>
                      </span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">Country:</label>
                <div class="col-sm-8">
                    <ui-select multiple ng-model="table.selectedCountries" theme="bootstrap" sortable="true" close-on-select="false">
                        <ui-select-match placeholder="Select Country">{% verbatim %}{{ $item.displayName }}{% endverbatim %}</ui-select-match>
                        <ui-select-choices repeat="country in table.countries | filter:$select.search">
                            {% verbatim %}{{ country.displayName }}{% endverbatim %}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
            <div class="form-group" ng-show="table.selectedCountries.length > 0">
                <label class="col-sm-2 control-label">Sector:</label>
                <div class="col-sm-8">
                    <ui-select multiple ng-model="table.selectedSectors" theme="bootstrap" sortable="true" close-on-select="false">
                        <ui-select-match placeholder="Select sector">{% verbatim %}{{ $item.displayName }}{% endverbatim %}</ui-select-match>
                        <ui-select-choices repeat="sector in table.sectors | orderBy:'displayName'| filter:$select.search">
                          {% verbatim %}{{ sector.displayName }}{% endverbatim %}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
            <div class="form-group" ng-show="table.selectedCountries.length > 0">
                <label class="col-sm-2 control-label">User Group:</label>
                <div class="col-sm-8">
                    <ui-select multiple ng-model="table.selectedUserGroups" theme="bootstrap" sortable="true" close-on-select="false">
                        <ui-select-match placeholder="Select user group">{% verbatim %}{{ $item.displayName }}{% endverbatim %}</ui-select-match>
                        <ui-select-choices repeat="group in table.userGroups | orderBy:'displayName'| filter:$select.search">
                          {% verbatim %}{{ group.displayName }}{% endverbatim %}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
            <div class="form-group" ng-show="table.selectedCountries.length > 0">
                <label class="col-sm-2 control-label">User Role:</label>
                <div class="col-sm-8">
                    <ui-select multiple ng-model="table.selectedUserRoles" theme="bootstrap" sortable="true" close-on-select="false">
                        <ui-select-match placeholder="Select user role">{% verbatim %}{{ $item.displayName }}{% endverbatim %}</ui-select-match>
                        <ui-select-choices repeat="group in table.userRoles | orderBy:'displayName'| filter:$select.search">
                          {% verbatim %}{{ group.displayName }}{% endverbatim %}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
            <div class="form-group">
                <label class="col-sm-2 control-label">State:</label>
                <div class="col-sm-8">
                    <ui-select ng-model="table.selectedStatus" theme="bootstrap" sortable="true" close-on-select="true">
                        <ui-select-match>{% verbatim %}{{ $select.selected.text }}{% endverbatim %}</ui-select-match>
                        <ui-select-choices repeat="status in table.statuses">
                          {% verbatim %}{{ status.text }}{% endverbatim %}
                        </ui-select-choices>
                    </ui-select>
                </div>
            </div>
        </div>
        <table datatable="ng" dt-instance="table.dtInstanceCallback" dt-options="table.dtOptions" dt-column-defs="table.dtColumnDefs" class="table table-striped">
            <thead>
                <tr class="search-result-header">
                    <th>Name</th>
                    <th>Country</th>
                    <th>Username</th>
                    <th>State</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr ng-repeat="user in table.users | bySearch:table.searchField | byCountry:table.selectedCountries | bySector:table.selectedSectors | byUserGroup:table.selectedUserGroups | byUserRoles:table.selectedUserRoles | byStatus:table.selectedStatus">
                    <td>
                        <p>
                        {% verbatim %}
                            {{ user.displayName }}
                        {% endverbatim %}
                        </p>
                        <small>
                            {% verbatim %}
                                {{ user.roles.length }}
                            {% endverbatim %}
                            {% trans "user roles" %}
                        </small>
                    </td>
                    <td>
                        <span ng-repeat="country in user.countries">
                            {% verbatim %}
                                {{ country.displayName }}
                            {% endverbatim %}
                        </span>
                    </td>
                    <td>
                        {% verbatim %}
                            {{ user.username }}
                        {% endverbatim %}</td>
                    <td>
                        {% verbatim %}
                            {{ user.status }}
                        {% endverbatim %}
                    </td>
                    <td><a href="{% verbatim %}{{ user.show_url }}{% endverbatim %}">Profile</a> | <a href="{% verbatim %}{{ user.edit_url }}{% endverbatim %}">Edit</a></td>
                </tr>
            </tbody>
        </table>
    </div>
{% endblock container %}
