{% extends "users/base_template.html" %}
{% load static %}
{% load i18n %}

{% block js %} {{ block.super }}
    <script src="{% static 'users/js/controllers/edit_controller.js' %}"></script>
{% endblock %}

{% block bread-crumb %}
    <div class="top10">
        <a class="nav-link" href="{% url 'users' %}"><i class="glyphicon glyphicon-chevron-left"></i> <span>{%  trans 'User Management' %}</span></a>
    </div>
{% endblock bread-crumb %}

{% block container %}
    <div class="user_details">
        <h2>{{ dhis_user.displayName}}</h2>
        <span>{{ dhis_user.userCredentials.username }}</span>
        <hr>
    </div>
    <div class="user-edit-form" ng-app="cumaApp" ng-controller="editController as ctrl" ng-cloak>
        <div class="bread-crumb clearfix">
            <div><span ng-class="{complete:ctrl.selectedNodes.length > 0, active: ctrl.activeStep === 1}" ><i class="fa fa-check" ></i> 1. <span >Select Organization Units</span></span></div>
            <div><span ng-class="{complete:false, active: ctrl.activeStep === 2}" ><i class="fa fa-check" ></i> 2. <span >Assign User Group</span></span></div>
            <div><span ng-class="{complete:false, active: ctrl.activeStep === 3}" ><i class="fa fa-check" ></i> 3. <span >Assign IRC Roles</span></span></div>
        </div>

        <div ng-show="ctrl.activeStep === 1">
            <label class="section-label"><span>{% trans "Select Organization Units" %}</span>:</label>
            <p>Countries chosen will 'filter' your choices in the next steps</p>
            <div class="organisation-units section clearfix">
                {% for chunks in organizationUnits %}
                    <div class="col-sm-4">
                        {% for row in chunks %}
                            <div class="row">
                                <treecontrol class="tree-light" tree-model="{{ row }}" on-selection="ctrl.showSelected(node)" options="ctrl.treeOptions">
                                    {% verbatim %}
                                        {{ node.displayName }}
                                    {% endverbatim %}
                                </treecontrol>
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="action-row" >
                <button class="btn btn-primary" ng-disabled="ctrl.selectedNodes.length === 0" ng-click="ctrl.goToStep(2)" >
                    <span>{% trans 'Next' %}</span>
                </button>
                <a href="{% url 'users' %}" >{% trans 'Return to User List' %}</a>
            </div>
        </div>
        <div ng-show="ctrl.activeStep === 2">
            <div class="row">
                <label class="section-label"><span>{% trans "Select User Roles" %}</span>:</label>
                <div class="col-sm-5">
                    <div ng-repeat="item in ctrl.roleForms">
                        <div class="box-without-border">
                            <div class="input-group margin-bottom-10">
                                <ui-select allow-clear ng-model="item.role.selected" theme="bootstrap">
                                    <ui-select-match placeholder="Chose role">
                                        {% verbatim %}
                                            {{ $select.selected.name }}
                                        {% endverbatim %}
                                    </ui-select-match>
                                    <ui-select-choices repeat="roleItem in ctrl.roles">
                                        {% verbatim %}
                                            {{ roleItem.name}}
                                        {% endverbatim %}
                                    </ui-select-choices>
                                </ui-select>

                                <span class="input-group-btn">
                                    <button type="button" ng-click="item.role.selected = undefined; item.country.selected = undefined;" class="btn btn-default">
                                        <span class="glyphicon glyphicon-remove"></span>
                                   </button>
                                </span>
                            </div>

                            <div ng-show="item.role.selected !== undefined" class="input-group margin-bottom-10">
                                <ui-select allow-clear ng-model="item.country.selected" theme="bootstrap">
                                    <ui-select-match placeholder="Chose Country">
                                        {% verbatim %}
                                            {{ $select.selected.displayName }}
                                        {% endverbatim %}
                                    </ui-select-match>
                                    <ui-select-choices repeat="countryItem in ctrl.selectedNodes">
                                        {% verbatim %}
                                            {{ countryItem.displayName }}
                                        {% endverbatim %}
                                    </ui-select-choices>
                                </ui-select>

                                <span class="input-group-btn">
                                    <button type="button" ng-click="item.country.selected = undefined" class="btn btn-default">
                                        <span class="glyphicon glyphicon-remove"></span>
                                   </button>
                                </span>
                            </div>
                            <button ng-show="item.country.selected && item.show_button" class="add_role_button btn-xs btn-success" ng-click="ctrl.addRole(item)"><span class="glyphicon glyphicon-plus"></span> {% trans "Add Role" %}</button>
                        </div>
                    </div>
                </div>
                <div class="col-sm-5">
                    <div class="box box-center">
                        <label class=""><span>{% trans "Current Roles Assigned" %}</span></label>
                    </div>
                </div>
            </div>
            <div class="action-row">
                <button class="btn btn-primary" ng-disabled="ctrl.selectedNodes.length === 0" ng-click="ctrl.goToStep(2)" >
                    <span>{% trans 'Next' %}</span>
                </button>
                <a href="{% url 'users' %}" >{% trans 'Return to User List' %}</a>
            </div>
        </div>
    </div>
{% endblock container %}